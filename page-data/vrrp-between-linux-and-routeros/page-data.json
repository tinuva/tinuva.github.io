{"componentChunkName":"component---src-templates-blog-post-js","path":"/vrrp-between-linux-and-routeros","result":{"data":{"contentfulBlogs":{"id":"89df2ae3-aec3-54fa-9cc7-aa2ca52230b5","title":"VRRP between Linux and RouterOS / Mikrotik","slug":"vrrp-between-linux-and-routeros","featureImage":null,"description":{"childMarkdownRemark":{"html":"<h3>VRRP</h3>\n<p><img src=\"//images.ctfassets.net/4djbomgx60kj/61JVCyCiPd9KqTKCntqUqq/b015697b3b7e74a851d893d2287aec00/vrrp.png\" alt=\"vrrp\"></p>\n<p>The Virtual Router Redundancy Protocol (VRRP) is a computer networking protocol that provides for automatic assignment of available Internet Protocol (IP) routers to participating hosts. This increases the availability and reliability of routing paths via automatic default gateway selections on an IP subnetwork. </p>\n<p>Reference: <a href=\"https://en.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol\">Wikipedia</a></p>\n<h3>Why</h3>\n<p>I couldn't find a guide on how to do this. There are plenty guides setting up VRRP on RouterOS between two Mikrotik devices, plenty for Cisco, plenty for Linux using Keepalived, and so on and so forth...</p>\n<p>And so this guide...</p>\n<h3>OK but Why...</h3>\n<p>Ok but why did I need this you may ask?</p>\n<p>In my specific situation, I have a DNS server running <a href=\"https://pi-hole.net\">Pi-hole</a> which is a Linux network-level advertisement and Internet tracker blocking application which acts as a DNS sinkhole, intended for use on a private network.</p>\n<p>What happen is, this runs on a big server, however here in sunny South Africa we at times have power outages, otherwise known as load-shedding or blackouts in other countries over the world. When this happen, the fileserver loses power, but small devices like the Mikrotik Router, Ubiquiti wifi and FTTH ONT stays online...except nothing can resolve DNS when everything is configured to query the <a href=\"https://pi-hole.net\">Pi-hole</a> server which is now down.</p>\n<p>The solution was born, using VRRP to have a floating ip address, which all devices will be configured to use. When the <a href=\"https://pi-hole.net\">Pi-hole</a> server is online, the IP address will be on there, and block advertisements, and when it goes offline, the Mikrotik router will take over answering DNS queries. The failover happens very quickly, in less than a second.</p>\n<h3>RouterOS</h3>\n<p>On the Mikrotik side, its fairy easy, I will make use of a screenshot to show what is needed.</p>\n<p><img src=\"//images.ctfassets.net/4djbomgx60kj/7fTOnuSWlwwL1of3f8LV7P/739744fa6591f8ab90114dcd8026fc78/routeros-vrrp.png\" alt=\"routeros-vrrp\"></p>\n<ol>\n<li>Create a new interface in the VRRP tab</li>\n<li>Select the LAN interface, bridge1 in my case</li>\n<li>Choose a VRID, 2 here</li>\n<li>Priority is 100 (as this will be my backup)</li>\n<li>Interval is 1.00 for 1 second</li>\n<li>Setup authentication. I wanted to use 'ah' but settled for 'simple' and you need version 2 for IPv4. Version 3 of VRRP is intended for IPv6.</li>\n</ol>\n<h3>Linux</h3>\n<p>On the Linux OS side, I make use of <a href=\"https://www.keepalived.org\">Keepalived</a> which can do both virtual ip addresses using VRRP and also simple load-balancing. We will only use the former.</p>\n<p>This is the /etc/keepalived/keepalived.conf to match up to the VRRP on the Mikrotik:</p>\n<pre><code class=\"language-javascript\">! Configuration File for keepalived\n\nglobal_defs {\n   router_id LVS_DEVEL\n   vrrp_skip_check_adv_addr\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface eth0\n    virtual_router_id 2\n    priority 200\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass pihole77\n    }\n    virtual_ipaddress {\n        192.168.241.2/24\n    }\n}\n</code></pre>\n<ol>\n<li>Router id matches the Mikrotik</li>\n<li>Prioty is doubled up to 200 to make this the master</li>\n<li>advert_int is 1 for 1 second</li>\n<li>Authentication match up to the Mikrotik</li>\n</ol>\n<h3>Slow...</h3>\n<p>There was one issue I ran in to. <a href=\"https://pi-hole.net\">Pi-hole</a> service takes a few minutes to start up, mostly combining my huge amount of blacklists from the internet. The problem with this is, if the ip address move over before this complete, I have downtime on the DNS.</p>\n<p>The solution to this, <a href=\"https://www.keepalived.org\">Keepalived</a> isn't set to auto start, but controlled through a very simplisting bash/cron script, that check if we can resolve dns locally on the <a href=\"https://pi-hole.net\">Pi-hole</a> server before starting up <a href=\"https://www.keepalived.org\">Keepalived</a>.</p>\n<pre><code class=\"language-bash\">#!/bin/bash\n\nDNSCHECK=`dig localhost @192.168.241.186 +short`\n#KEEPALIVE=`/etc/init.d/keepalived status | grep started`\n\nif [ $DNSCHECK = '127.0.0.1' ]\nthen\n  echo \"DNS IS UP!\"\n  /etc/init.d/keepalived status | grep started > /dev/null\n  if [ $? -ne 0 ]; then\n    echo \"Keepalive not running, lets start it\"\n    /etc/init.d/keepalived zap > /dev/null\n    /etc/init.d/keepalived start > /dev/null\n  fi\nelse\n  echo \"DNS IS DOWN!\"\n  /etc/init.d/keepalived status | grep started > /dev/null\n  if [ $? -eq 0 ]; then\n    echo \"Keepalive is running, lets stop it\"\n    /etc/init.d/keepalived stop > /dev/null\n  fi\nfi\n</code></pre>\n<h3>END</h3>\n<p>So there you have it. A little bit of work, but makes for a smooth transition between the Pi-hole server and the Mikrotik router. Let me know in the comments what you think.</p>"}},"createdAt":"2022-05-01T14:39:31.287Z"},"contentfulSiteInformation":{"siteUrl":"https://tinuva.github.io","twitterHandle":"@tinuvaza"}},"pageContext":{"slug":"vrrp-between-linux-and-routeros"}},"staticQueryHashes":["1242132861","1757532457"]}
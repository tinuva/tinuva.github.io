{"componentChunkName":"component---src-templates-blog-post-js","path":"/install-nodered-using-docker-compose-and-cloudflare","result":{"data":{"contentfulBlogs":{"id":"a121a952-c263-533c-900b-a37bfc6a6636","title":"Install Nodered using docker-compose and CloudFlare","slug":"install-nodered-using-docker-compose-and-cloudflare","featureImage":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAMAAACejr5sAAABOFBMVEVnYmJrampmZmZSUlJdXV1cXFxQUFBRUVFZWVlUVFRaWlpgYGB+fn16enphYWHu7u709PT29vb59/n9/P36+ff59fD59/T48ur7+/v8/Pzw8PD6+vr9/f3g1trDsLjn4OPj3uTk3eP08/Ty7unt4NLv597u6+Tq2Lnw7eP+/v7////x8fHs7Ozs5Obf0NPy7O3s5ezj2uPi2uLu6e75+fnu5tvPxK2xrI67tZjp4NLo6Ojy8vL39/f19fXs69rW1rHu7uD29/fp6ejt7e3i4eLLy8vq6urZ4ObN1d34+frg59/Azb7P2s7h4eHl7PDw8vPr5dzay7fw6uLz8/Pl5eXh5+vq6+3v7+/r6+vt8PHV4OXh5uvn6evk5OTi4uL19fbt7e7u7u/v7/Dp6ene3t7w7u7l3+Dk3+COi0jvAAAACXBIWXMAABcRAAAXEQHKJvM/AAAAB3RJTUUH5gUBDisRastKuwAAAKZJREFUGBlNwUFLAkEAhuHvnZnUapfNvJUFQRDmUTuJN8/+3U76C6JAELxXS9BhidwKwpl2acF5HkTD2+CNAX4OyQBR8XbnRCWUXBDTax8Fd0LkQyYDXBf4fEvRv9v2o0bM4EWVcEmtOIWtS0A1nlUbAB3n3K8iLWBp8nvFVvb9aWquh4qN7Xl+bA4SxR6cvSvtUW+Ram9iTPrFWVfFFWqs/fx7c/MHqO8lcFIskJcAAAAASUVORK5CYII=","aspectRatio":1.5120192307692308,"src":"//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=1500&q=50","srcSet":"//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=375&h=248&q=50 375w,\n//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=750&h=496&q=50 750w,\n//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=1258&h=832&q=50 1258w","srcWebp":"//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=1500&q=50&fm=webp","srcSetWebp":"//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=375&h=248&q=50&fm=webp 375w,\n//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=750&h=496&q=50&fm=webp 750w,\n//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png?w=1258&h=832&q=50&fm=webp 1258w","sizes":"(max-width: 1500px) 100vw, 1500px"}},"description":{"childMarkdownRemark":{"html":"<h2>Node-RED</h2>\n<p>A visual tool for wiring the Internet of Things.</p>\n<p><img src=\"//images.ctfassets.net/4djbomgx60kj/6T9G2lXH8waplTPckuCqgy/7c60792fc29c46a3febe6945fd53d7ed/poster.png\" alt=\"poster-nodered\"></p>\n<h2>Overview</h2>\n<p>I am planning on writing a series of different posts on using <a href=\"https://nodered.org/\">Node-RED</a> and so this is the first post of the series. It will have a small twist, in that I will be setting it up using docker-compose with a <a href=\"https://letsencrypt.org/\">Let's Encrypt</a> certificate using Traefik for the reverse proxy and lastly, <a href=\"https://www.cloudflare.com/\">CloudFlare</a> for DNS.</p>\n<p>As a bonus, I will also add <a href=\"https://github.com/containrrr/watchtower\">Watchtower</a> to automate updates of <a href=\"https://traefik.io/\">Traefik</a> and [Node-Red.]</p>\n<h2>Goals</h2>\n<p>After finishing the instructions in this blog post, you will have:</p>\n<ul>\n<li>Used docker-compose</li>\n<li><a href=\"https://nodered.org/\">Node-RED</a> installed without exposing the ports using docker</li>\n<li><a href=\"https://traefik.io/\">Traefik</a> installed as reverse-proxy</li>\n<li>Ability to have multiple apps behind unique subdomains on your domain.tld using <a href=\"https://letsencrypt.org/\">Let's Encrypt</a> certificates</li>\n</ul>\n<h2>Requirements</h2>\n<ul>\n<li>Linux Host for Docker and <a href=\"https://nodered.org/\">Node-RED</a> - Can be a VPS or Raspberry Pi ect.</li>\n<li><a href=\"https://www.cloudflare.com/\">CloudFlare</a> account with <a href=\"https://support.cloudflare.com/hc/en-us/articles/200167836-Where-do-I-find-my-Cloudflare-API-key-\">API key</a></li>\n<li>Domain with DNS hosted by <a href=\"https://www.cloudflare.com/\">CloudFlare</a></li>\n<li>You will need to point a *.domain.tld record to your Linux host. The reason for this is, we will be using subdomains to point to different services running in docker. In this example, I will be pointing nodered.domain.tld to my nodered container for easy access.</li>\n</ul>\n<h2>Preperation</h2>\n<p>Usually I have a separate volume for my data mounted on /data and on this volume I will create a folder named <em>docker</em> with all my files in. </p>\n<p>We will create 2 files /data/docker to start with.</p>\n<p>First file will contain our authentication and keys: <code>.env</code></p>\n<pre><code class=\"language-bash\">PUID=1001\nPGID=1001\nTZ=Africa/Johannesburg\nUSERDIR=/data\n\nDOMAINNAME=domain.tld\nCLOUDFLARE_EMAIL=cloudflare@domain.tld\nCLOUDFLARE_API_KEY=abcdefghiklmnopqrstvwxyz01234567897e8c6\n\nHTTP_USERNAME=tinuva\nHTTP_PASSWORD=$apr1$bJ77aaaaaaaaaaaaaaaaaaaaaaaaaaax/vO0\nAPI_HTTP_USERNAME=nodered\nAPI_HTTP_PASSWORD=$apr1$bbbbbbbbbbbbbbbbbbbbbbbbbnElz47L1\n</code></pre>\n<p>To do:</p>\n<ol>\n<li>Replace <code>domain.tld</code> with your domain that is hosted with <a href=\"https://www.cloudflare.com/\">CloudFlare</a></li>\n<li>Set your timezone</li>\n<li>Create a .htpass file with <a href=\"http://aspirine.org/htpasswd_en.html\">HTPASSWD Generator</a> then place the username and passwords into the above fields.\nInitially we will only use the HTTP<em>USERNAME and HTTP</em>PASSWORD. The API versions will be used at a later stage when we create an API endpoint using <a href=\"https://nodered.org/\">Node-RED</a></li>\n</ol>\n<p>Next we will create a <code>docker-compose.yml</code> file/</p>\n<pre><code class=\"language-yaml\">version: '2.1'\n\nservices:\n  nodered:\n    image: nodered/node-red-docker:slim-v10\n    container_name: nodered\n    volumes:\n      - ${USERDIR}/docker/nodered/data:/data\n      - /etc/localtime:/etc/localtime\n    restart: always\n    mem_limit: 100m\n    cpu_shares: 50\n    labels:\n      - \"traefik.enable=true\"\n      - \"traefik.backend=nodered\"\n      - \"traefik.frontend.redirect.entryPoint=https\"\n      - \"traefik.port=1880\"\n      - \"traefik.protocol=http\"\n      - \"traefik.docker.network=docker_traefik_proxy\"\n      - \"traefik.ifttt.frontend.rule=Host:nodered.${DOMAINNAME};Path:/ifttt\"\n      - \"traefik.ifttt.frontend.auth.basic.users=${API_HTTP_USERNAME}:${API_HTTP_PASSWORD}\"\n      - \"traefik.web.frontend.rule=Host:nodered.${DOMAINNAME}\"\n      - \"traefik.web.frontend.auth.basic.users=${HTTP_USERNAME}:${HTTP_PASSWORD}\"\n      - com.centurylinklabs.watchtower.enable=true\n\n  traefik:\n    hostname: traefik\n    image: traefik:latest\n    container_name: traefik\n    restart: always\n    domainname: ${DOMAINNAME}\n    cpu_shares: 30\n    mem_limit: 250m\n    ports:\n      - 80:80\n      - 443:443\n    environment:\n      - CLOUDFLARE_EMAIL=${CLOUDFLARE_EMAIL}\n      - CLOUDFLARE_API_KEY=${CLOUDFLARE_API_KEY}\n    labels:\n      - \"traefik.enable=true\"\n      - \"traefik.backend=traefik\"\n      - \"traefik.frontend.rule=Host:traefik.${DOMAINNAME}\"\n      - \"traefik.frontend.redirect.entryPoint=https\"\n      - \"traefik.port=8080\"\n      - \"traefik.docker.network=docker_traefik_proxy\"\n      - \"traefik.frontend.auth.basic.users=${HTTP_USERNAME}:${HTTP_PASSWORD}\"\n      - com.centurylinklabs.watchtower.enable=true\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - ${USERDIR}/docker/traefik:/etc/traefik\n      - ${USERDIR}/docker/shared:/shared\n\n  watchtower:\n    image: v2tec/watchtower:latest\n    container_name: watchtower\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n      - /etc/localtime:/etc/localtime:ro\n    command: --schedule \"0 30 5 * * *\" --cleanup --label-enable\n    restart: always\n    mem_limit: 50m\n    cpu_shares: 25\n</code></pre>\n<p>We also need to create folders and set ownership to match the above.</p>\n<pre><code class=\"language-bash\">mkdir /data/docker/shared\nmkdir -p /data/docker/nodered/data\nmkdir -p /data/docker/traefik/acme\n\ntouch /data/docker/traefik/rules.toml\ntouch /data/docker/traefik/acme/acme.json\nchmod 600 /data/docker/traefik/acme/acme.json\n\nchown -R 1001.1001 /data/docker/nodered\nchown -R 1001.1001  /data/docker/traefik\nchown 1001.1001  /data/docker/shared\n</code></pre>\n<p>Create <a href=\"https://traefik.io/\">Traefik</a>'s config file: <code>/data/docker/traefik/traefik.toml</code></p>\n<pre><code class=\"language-toml\">#debug = true\n\nlogLevel = \"ERROR\" #DEBUG, INFO, WARN, ERROR, FATAL, PANIC\nInsecureSkipVerify = true \ndefaultEntryPoints = [\"https\", \"http\"]\n\n# WEB interface of Traefik - it will show web page with overview of frontend and backend configurations \n[api]\n  entryPoint = \"traefik\"\n  dashboard = true\n  address = \":8080\"\n\n# Force HTTPS\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n    [entryPoints.http.redirect]\n    entryPoint = \"https\"\n  [entryPoints.https]\n  address = \":443\"\n    [entryPoints.https.tls]\n\n[file]\n  watch = true\n  filename = \"/etc/traefik/rules.toml\"\n\n# Let's encrypt configuration\n[acme]\nemail = \"email@domain.com\" #any email id will work\nstorage=\"/etc/traefik/acme/acme.json\"\nentryPoint = \"https\"\nacmeLogging=true \nonDemand = false #create certificate when container is created\n[acme.dnsChallenge]\n  provider = \"cloudflare\"\n  delayBeforeCheck = 300\n[[acme.domains]]\n   main = \"domain.tld\"\n[[acme.domains]]\n   main = \"*.domain.tld\"\n\n# Connection to docker host system (docker.sock)\n[docker]\nendpoint = \"unix:///var/run/docker.sock\"\ndomain = \"domain.tld\"\nwatch = true\n# This will hide all docker containers that don't have explicitly  \n# set label to \"enable\"\nexposedbydefault = false\n</code></pre>\n<p>Replace/Configure:</p>\n<ol>\n<li>email@domain.com: with your email.</li>\n<li>domain.tld: with your private domain name.</li>\n<li>InsecureSkipVerify = true: I had to add at the beginning to allow some apps (eg. UniFi controller) be accessible through Traefik.</li>\n<li>provider = \"cloudflare\": Change to your DNS provider for DNS challenge.</li>\n<li>exposedbydefault = false: This will force you to use traefik.enable=true label in docker compose to put apps behind traefik.</li>\n<li>If you want to use another DNS provider instead of CloudFlare, review the list of <a href=\"https://docs.traefik.io/configuration/acme/#provider\">available providers</a> on the Traefik documentation</li>\n</ol>\n<h2>Install Docker</h2>\n<p>Ok lets install docker.</p>\n<p>I have a CentOS host which the following work:</p>\n<pre><code class=\"language-bash\">sudo yum install -y yum-utils \\\n  device-mapper-persistent-data \\\n  lvm2\n\nsudo yum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n\nsudo yum install docker-ce docker-ce-cli containerd.io\n\nsystemctl start docker\nsystemctl enable docker\n</code></pre>\n<p>Reference: <a href=\"https://docs.docker.com/install/linux/docker-ce/centos/\">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>\n<p>On Ubuntu the commands will be:</p>\n<pre><code class=\"language-bash\">sudo apt-get update\n\nsudo apt-get install \\\n    apt-transport-https \\\n    ca-certificates \\\n    curl \\\n    gnupg-agent \\\n    software-properties-common\n\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n\nsudo add-apt-repository \\\n   \"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   $(lsb_release -cs) \\\n   stable\"\n\nsudo apt-get update\n\nsudo apt-get install docker-ce docker-ce-cli containerd.io\n</code></pre>\n<p>Reference: <a href=\"https://docs.docker.com/install/linux/docker-ce/ubuntu/\">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>\n<h2>Install docker-compose</h2>\n<p>First confirm <code>pip</code> is installed:</p>\n<p>On CentOS:</p>\n<pre><code class=\"language-bash\">yum install python-pip\n</code></pre>\n<p>On Ubuntu:</p>\n<pre><code class=\"language-bash\">apt install python-pip\n</code></pre>\n<p>Then install docker-compose:</p>\n<pre><code class=\"language-bash\">pip install docker-compose\n</code></pre>\n<h2>Start containers with docker-compose</h2>\n<p>Starting the containers is as simple as:</p>\n<pre><code class=\"language-bash\">cd /data/docker &#x26;&#x26; docker-compose up -d --remove-orphans &#x26;&#x26; docker-compose logs -f --tail 10\n</code></pre>\n<p>You should see output like the following:</p>\n<pre><code class=\"language-bash\">[root@thor docker]# cd /data/docker &#x26;&#x26; docker-compose up -d --remove-orphans &#x26;&#x26; docker-compose logs -f --tail 10\nPulling traefik (traefik:latest)...\nlatest: Pulling from library/traefik\nd572f7c8e983: Pull complete\nd62b0f6adf29: Pull complete\nDigest: sha256:02cfdb77b0cd82d973dffb3dafe498283f82399bd75b335797d7f0fe3ebeccb8\nStatus: Downloaded newer image for traefik:latest\nPulling watchtower (v2tec/watchtower:latest)...\nlatest: Pulling from v2tec/watchtower\na5415f98d52c: Pull complete\nc3f7208ad77c: Pull complete\n169c1e589d74: Pull complete\nDigest: sha256:4cb6299fe87dcbfe0f13dcc5a11bf44bd9628a4dae0035fecb8cc2b88ff0fc79\nStatus: Downloaded newer image for v2tec/watchtower:latest\nPulling nodered (nodered/node-red-docker:slim-v10)...\nslim-v10: Pulling from nodered/node-red-docker\ne7c96db7181b: Pull complete\nbbec46749066: Pull complete\n89e5cf82282d: Pull complete\n5de6895db72f: Pull complete\n6c5493c0ae88: Pull complete\n6ace8e934b90: Pull complete\ne37b30d9d482: Pull complete\n95734c8da825: Pull complete\ncf430c1fac0c: Pull complete\nDigest: sha256:42126aab7325a3133f47e0a89bb14a3985c8d4daeb8d8a3c0e19cfe9137e1c79\nStatus: Downloaded newer image for nodered/node-red-docker:slim-v10\nCreating traefik    ... done\nCreating nodered    ... done\nCreating watchtower ... done\nAttaching to nodered, watchtower, traefik\nnodered       |\nnodered       | > node-red-docker@1.0.0 start /usr/src/node-red\nnodered       | > node $NODE_OPTIONS node_modules/node-red/red.js -v $FLOWS \"--userDir\" \"/data\"\nnodered       |\nwatchtower    | time=\"2019-07-22T17:12:26+02:00\" level=info msg=\"First run: 2019-07-23 05:30:00 +0200 SAST\"\nnodered       | 22 Jul 17:12:28 - [info]\nnodered       |\nnodered       | Welcome to Node-RED\nnodered       | ===================\nnodered       |\nnodered       | 22 Jul 17:12:28 - [info] Node-RED version: v0.20.7\nnodered       | 22 Jul 17:12:28 - [info] Node.js  version: v10.16.0\nnodered       | 22 Jul 17:12:28 - [info] Linux 3.10.0-957.21.3.el7.x86_64 x64 LE\nnodered       | 22 Jul 17:12:28 - [info] Loading palette nodes\nnodered       | 22 Jul 17:12:30 - [warn] rpi-gpio : Raspberry Pi specific node set inactive\nnodered       | 22 Jul 17:12:30 - [warn] rpi-gpio : Cannot find Pi RPi.GPIO python library\nnodered       | 22 Jul 17:12:30 - [info] Settings file  : /data/settings.js\nnodered       | 22 Jul 17:12:30 - [info] Context store  : 'default' [module=memory]\nnodered       | 22 Jul 17:12:30 - [info] User directory : /data\nnodered       | 22 Jul 17:12:30 - [warn] Projects disabled : editorTheme.projects.enabled=false\nnodered       | 22 Jul 17:12:30 - [info] Flows file     : /data/flows.json\nnodered       | 22 Jul 17:12:30 - [info] Creating new flow file\nnodered       | 22 Jul 17:12:30 - [warn]\nnodered       |\nnodered       | ---------------------------------------------------------------------\nnodered       | Your flow credentials file is encrypted using a system-generated key.\nnodered       |\nnodered       | If the system-generated key is lost for any reason, your credentials\nnodered       | file will not be recoverable, you will have to delete it and re-enter\nnodered       | your credentials.\nnodered       |\nnodered       | You should set your own key using the 'credentialSecret' option in\nnodered       | your settings file. Node-RED will then re-encrypt your credentials\nnodered       | file using your chosen key the next time you deploy a change.\nnodered       | ---------------------------------------------------------------------\nnodered       |\nnodered       | 22 Jul 17:12:30 - [info] Server now running at http://127.0.0.1:1880/\nnodered       | 22 Jul 17:12:30 - [info] Starting flows\nnodered       | 22 Jul 17:12:30 - [info] Started flows\n</code></pre>\n<p>Do review the logs for a short while, it is possible that traefik failed to generate a certificate if your domain already has a TXT record for SPF. </p>\n<pre><code class=\"language-bash\">traefik       | time=\"2019-07-22T15:26:58Z\" level=error msg=\"Unable to obtain ACME certificate for domains \\\"domain.tld\\\" : unable to generate a certificate for the domains [domain.tld]: acme: Error -> One or more domains had a problem:\\n[domain.tld] [domain.tld] acme: error presenting token: cloudflare: failed to create TXT record: error from makeRequest: HTTP status 400: content \\\"{\\\\\\\"success\\\\\\\":false,\\\\\\\"errors\\\\\\\":[{\\\\\\\"code\\\\\\\":81057,\\\\\\\"message\\\\\\\":\\\\\\\"The record already exists.\\\\\\\"}],\\\\\\\"messages\\\\\\\":[],\\\\\\\"result\\\\\\\":null}\\\"\\n\"\n</code></pre>\n<h2>Success</h2>\n<p>If all good, you should now be able to access 2 services.</p>\n<ul>\n<li><a href=\"https://traefik.domain.tld\">https://traefik.domain.tld</a></li>\n<li><a href=\"https://nodered.domain.tld\">https://nodered.domain.tld</a></li>\n</ul>\n<p>Both will require a password set earlier. Nodered by default doesn't have authentication, and traefik's dashboard also doesn't, but that doesn't mean we need to keep it open to the world.</p>\n<p>Initially these may show up with a self-generated certificate while <a href=\"https://traefik.io/\">Traefik</a> work to generate and authenticate a wild-card certificate for your domain. Once this is complete, you will have a certificate issued with: Issued by: Let's Encrypt Authority X3</p>"}},"createdAt":"2022-05-01T14:42:02.999Z"},"contentfulSiteInformation":{"siteUrl":"https://tinuva.github.io","twitterHandle":"@tinuvaza"}},"pageContext":{"slug":"install-nodered-using-docker-compose-and-cloudflare"}},"staticQueryHashes":["1242132861","1757532457"]}